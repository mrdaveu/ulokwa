<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="stylesheet.css">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta name="description" content="my personal website">
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
   <link rel="icon" href="/photos/favicon.png" type="image/x-icon">
</head>


<div class="menu" id="menu">
   <div class="column-left">
       <div class="section-title" data-section="questions">questions</div>
       <div class="section-title" data-section="glossary">glossary</div>
       <div class="section-title" data-section="pictures">pictures</div>
       <div class="section-title" data-section="recipes">recipes</div>
       <div class="about">about</div>
   </div>

   <div class="column-right">
       <div class="section-items" id="questions-items">
           {% for item in collections.questions %}
           <div class="item" data-url=".{{ item.url }}">
               {{ item.data.title | downcase }}
           </div>
           {% endfor %}
       </div>

       <div class="section-items" id="glossary-items">
           {% for item in collections.glossary %}
           <div class="item" data-url=".{{ item.url }}">
               {{ item.data.title | downcase }}
           </div>
           {% endfor %}
       </div>

       <div class="section-items" id="pictures-items">
           {% for item in collections.pictures %}
           <div class="item" data-url=".{{ item.url }}">
               {{ item.data.title | downcase }}
           </div>
           {% endfor %}
       </div>

       <div class="section-items" id="recipes-items">
           {% for item in collections.recipes %}
           <div class="item" data-url=".{{ item.url }}">
               {{ item.data.title | downcase }}
           </div>
           {% endfor %}
       </div>


   </div>
</div>
<div class="background-title" id="backgroundTitle"></div>
<div class="article-view" id="articleView">
   <div class="article-view-wrapper">
       <div class="article-content" id="articleContent"></div>
   </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
   const sectionTitles = document.querySelectorAll('.section-title');
   const items = document.querySelectorAll('.item');
   const articleView = document.getElementById('articleView');
   const articleContent = document.getElementById('articleContent');

   // Cache for prefetched content
   const contentCache = new Map();
   let hoverTimeout = null;
   let currentPageUrl = null;

   // Function to display content
   async function displayContent(url, html) {
       currentPageUrl = url;
       articleContent.innerHTML = html;
       articleView.classList.add('visible');

       // If comments section exists (for empty questions), load comments
       const commentsList = document.getElementById('commentsList');
       if (commentsList) {
           await loadComments(url);
           document.getElementById('commentForm').addEventListener('submit', handleCommentSubmit);
       }
   }

   // Function to load comments from database
   async function loadComments(pageUrl) {
       try {
           const response = await fetch(`/.netlify/functions/get-comments?url=${encodeURIComponent(pageUrl)}`);
           const data = await response.json();

           const commentsList = document.getElementById('commentsList');
           if (data.comments && data.comments.length > 0) {
               commentsList.innerHTML = '<h3 class="comments-header">Comments</h3>' +
                   data.comments.map(comment => `
                       <div class="comment">
                           <div class="comment-header">
                               <span class="comment-author">${escapeHtml(comment.author_name || 'Anonymous')}</span>
                               <span class="comment-date">${formatDate(comment.created_at)}</span>
                           </div>
                           <div class="comment-body">${escapeHtml(comment.comment)}</div>
                       </div>
                   `).join('');
           }
       } catch (error) {
           console.error('Error loading comments:', error);
       }
   }

   // Function to handle comment submission
   async function handleCommentSubmit(e) {
       e.preventDefault();

       const authorName = document.getElementById('authorName').value.trim();
       const commentText = document.getElementById('commentText').value.trim();

       const submitBtn = e.target.querySelector('button[type="submit"]');
       submitBtn.disabled = true;
       submitBtn.textContent = 'Submitting...';

       try {
           const response = await fetch('/.netlify/functions/post-comment', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                   pageUrl: currentPageUrl,
                   comment: commentText,
                   authorName: authorName || 'Anonymous'
               })
           });

           if (response.ok) {
               // Clear form
               document.getElementById('authorName').value = '';
               document.getElementById('commentText').value = '';

               // Reload comments
               await loadComments(currentPageUrl);

               submitBtn.textContent = 'Submitted!';
               setTimeout(() => {
                   submitBtn.textContent = 'Add comment';
                   submitBtn.disabled = false;
               }, 2000);
           } else {
               throw new Error('Failed to submit comment');
           }
       } catch (error) {
           console.error('Error submitting comment:', error);
           submitBtn.textContent = 'Error - Try again';
           setTimeout(() => {
               submitBtn.textContent = 'Add comment';
               submitBtn.disabled = false;
           }, 2000);
       }
   }

   // Utility functions
   function escapeHtml(text) {
       const div = document.createElement('div');
       div.textContent = text;
       return div.innerHTML;
   }

   function formatDate(dateString) {
       const date = new Date(dateString);
       const now = new Date();
       const diff = now - date;
       const days = Math.floor(diff / (1000 * 60 * 60 * 24));

       if (days === 0) return 'Today';
       if (days === 1) return 'Yesterday';
       if (days < 7) return `${days} days ago`;
       return date.toLocaleDateString();
   }

   // About button handler
   const aboutBtn = document.querySelector('.about');
   aboutBtn.addEventListener('click', function() {
       const isActive = this.classList.contains('active');

       if (isActive) {
           // Close about
           this.classList.remove('active');
           sectionTitles.forEach(t => t.style.display = '');
       } else {
           // Open about - hide other section titles
           this.classList.add('active');
           sectionTitles.forEach(t => t.style.display = 'none');
           document.querySelectorAll('.section-items').forEach(item => item.classList.remove('active'));
       }
   });

   sectionTitles.forEach(title => {
       title.addEventListener('click', function() {
           const section = this.getAttribute('data-section');

           // Hide about if showing
           aboutBtn.classList.remove('active');
           sectionTitles.forEach(t => t.style.display = '');

           // Remove active class from all section titles
           sectionTitles.forEach(t => t.classList.remove('active'));

           // Add active class to clicked title
           this.classList.add('active');

           // Hide all section items
           document.querySelectorAll('.section-items').forEach(item => {
               item.classList.remove('active');
           });

           // Show the clicked section's items
           const targetSection = document.getElementById(section + '-items');
           if (targetSection) {
               targetSection.classList.add('active');
           }

           // Close any open article
           const menu = document.getElementById('menu');
           menu.classList.remove('article-open');
           articleView.classList.remove('visible');
           articleContent.innerHTML = '';
           document.querySelectorAll('.item.selected').forEach(i => i.classList.remove('selected'));
           document.querySelectorAll('.section-items.item-selected').forEach(s => s.classList.remove('item-selected'));
       });
   });

   items.forEach(item => {
       // Prefetch on hover
       item.addEventListener('mouseenter', function() {
           const url = this.getAttribute('data-url');

           if (url && !contentCache.has(url)) {
               hoverTimeout = setTimeout(() => {
                   fetch(url)
                       .then(response => response.text())
                       .then(html => {
                           contentCache.set(url, html);
                       })
                       .catch(err => {
                           contentCache.set(url, '<p>Error loading content</p>');
                       });
               }, 150); // Prefetch after 150ms hover
           }
       });

       item.addEventListener('mouseleave', function() {
           if (hoverTimeout) {
               clearTimeout(hoverTimeout);
               hoverTimeout = null;
           }
       });

       item.addEventListener('click', function(e) {
           e.stopPropagation();
           const parentSection = this.closest('.section-items');
           const menu = document.getElementById('menu');
           const isSelected = this.classList.contains('selected');

           if (isSelected) {
               // Close: restore menu state
               this.classList.remove('selected');
               parentSection.classList.remove('item-selected');
               menu.classList.remove('article-open');
               articleView.classList.remove('visible');
               articleContent.innerHTML = '';
           } else {
               // Open: hide other items, fetch content
               this.classList.add('selected');
               parentSection.classList.add('item-selected');
               menu.classList.add('article-open');

               const url = this.getAttribute('data-url');
               if (url) {
                   // Use cached content if available
                   if (contentCache.has(url)) {
                       displayContent(url, contentCache.get(url));
                   } else {
                       // Fallback to fetch if not cached
                       fetch(url)
                           .then(response => response.text())
                           .then(html => {
                               contentCache.set(url, html);
                               displayContent(url, html);
                           })
                           .catch(err => {
                               const errorHtml = '<p>Error loading content</p>';
                               contentCache.set(url, errorHtml);
                               displayContent(url, errorHtml);
                           });
                   }
               }
           }
       });
   });
});
</script>

</body>

</html>